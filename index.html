<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="site.title">PADOBI PC — сервис будущего</title>
  <meta name="description" content="PADOBI PC — сервисный центр: бесплатный курьер по Киеву, мастер на дом, гейм-зона для клиентов, сборка и апгрейд ПК." />
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --card:#0f0f0f;
      --muted:#a9a9a9;
      --text:#fff;
      --brand:#0ff;
      --accent:#a855f7;
      --radius:20px;
      --shadow:0 16px 48px rgba(0,0,0,.8);
      --container:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    .container{max-width:var(--container);margin:0 auto;padding:0 20px}

    /* Header */
    header{position:sticky;top:0;z-index:120;background:var(--bg);border-bottom:1px solid rgba(255,255,255,0.03);box-shadow:0 0 20px rgba(0,255,255,.04);backdrop-filter: blur(4px)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:72px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.6px}
    .brand__logo{width:42px;height:42px;border-radius:10px;overflow:hidden;flex-shrink:0;box-shadow:0 0 10px rgba(0,255,255,.15)}
    .brand__logo img{width:100%;height:100%;object-fit:cover}
    .brand__text{font-size:20px;text-transform:uppercase}
    .actions{display:flex;align-items:center;gap:10px}
    .icon-btn{position:relative;display:grid;place-items:center;width:42px;height:42px;border-radius:10px;background:var(--panel);border:1px solid #232323;cursor:pointer;transition:.18s;overflow:visible}
    .icon-btn:hover{transform:translateY(-2px);box-shadow:0 0 18px rgba(0,255,255,.16)}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--brand);color:#000;font-size:11px;font-weight:800;padding:2px 6px;border-radius:999px;border:2px solid var(--panel);box-shadow:0 0 10px var(--brand)}
    .dropdown{position:relative}
    .dropdown-menu{display:none;position:absolute;right:0;top:48px;background:var(--panel);border:1px solid #232323;border-radius:10px;min-width:200px;overflow:hidden;box-shadow:var(--shadow);z-index:110}
    .dropdown-menu a{display:block;padding:12px 16px;color:var(--text);font-size:14px}
    .dropdown.open .dropdown-menu{display:block}
    .lang{display:flex;gap:8px;margin-left:8px}
    .lang button{height:34px;padding:0 12px;border-radius:8px;border:1px solid #232323;background:#0d0d0d;color:#ddd;cursor:pointer;transition:.18s;font-weight:700;letter-spacing:.4px}
    .lang button.active{background:#fff;color:#000;box-shadow:0 0 12px rgba(0,255,255,.18)}
    .lang button:hover{background:#161616}
    .lang button:focus{outline:2px solid rgba(0,255,255,.06);outline-offset:2px}

    /* Header small avatar button */
    .profile-btn{width:40px;height:40px;border-radius:10px;padding:0;border:none;background:transparent;display:grid;place-items:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    .profile-btn img{width:100%;height:100%;object-fit:cover;display:block;border-radius:8px}
    .profile-btn svg{width:18px;height:18px}

    /* Sections */
    .section{padding:64px 0}
    .section .inner{max-width:900px;margin:0 auto;text-align:center;padding:0 12px}
    .section h2{font-size:28px;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}
    .section p.lead{color:var(--muted);text-align:center;max-width:760px;margin:0 auto 28px}

    /* Cards */
    .grid{display:grid;gap:28px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:960px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
    .card{position:relative;overflow:hidden;border-radius:var(--radius);background-size:cover;background-position:center;height:320px;display:flex;flex-direction:column;justify-content:center;align-items:center;border:1px solid #1f1f1f;box-shadow:var(--shadow);transition:all .35s ease}
    .card::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.6));transition:.3s}
    .card h3{margin:10px 0;font-size:20px;background:rgba(0,0,0,.5);padding:8px 14px;border-radius:10px;z-index:2;text-transform:uppercase;letter-spacing:.8px}
    .btn{display:inline-block;margin-top:14px;padding:12px 20px;border-radius:10px;border:none;background:var(--brand);color:#000;font-weight:900;cursor:pointer;transition:.25s;z-index:2;box-shadow:0 0 16px rgba(0,255,255,.55);text-transform:uppercase;letter-spacing:.8px}
    .btn:hover{background:#fff;box-shadow:0 0 30px var(--brand)}
    .card:hover{transform:translateY(-8px);box-shadow:0 6px 34px rgba(0,255,255,.12)}
    .card:hover::after{background:rgba(0,0,0,.35)}

    /* neon hover */
    .neon-hover:hover{box-shadow:0 0 12px rgba(0,255,255,.18),0 0 36px rgba(0,255,255,.06) inset;border-color: rgba(0,255,255,.08)}

    /* Services restored */
    .services h2{text-align:center}
    .services-grid {display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));}
    .service {background: #111;border: 1px solid #333;padding: 16px;border-radius: 12px;display:flex;justify-content:space-between;align-items:center;gap:12px;transition: all 0.3s ease;cursor:pointer;}
    .service:hover {border-color: #a855f7;box-shadow: 0 0 15px #a855f7, 0 0 30px #9333ea inset;transform: translateY(-3px);}
    .service svg { flex-shrink: 0; }
    .price { font-weight: bold; color: #a855f7; }
    .muted { color: var(--muted); } /* helper used in small tags */

    /* Center services note */
    .services-note{ text-align:center; color:var(--muted); margin-top:14px; }

    /* About / Reviews / FAQ */
    .about p{color:#d6d6d6;max-width:800px;margin:0 auto}
    .reviews-grid{display:grid;gap:20px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:960px){.reviews-grid{grid-template-columns:1fr}}
    .review{background:var(--panel);padding:22px;border-radius:16px;border:1px solid #202020}
    .review .stars{color:#ffd166;letter-spacing:2px;font-size:16px;margin-bottom:6px}

    .faq-grid{max-width:900px;margin:0 auto;display:grid;gap:12px}
    .faq-item{background:var(--panel);padding:18px 20px;border-radius:14px;border:1px solid #202020;transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; will-change:transform;}
    .faq-item:hover{transform: translateY(-8px);box-shadow: 0 18px 40px rgba(0,255,255,.04);border-color: rgba(0,255,255,.04);}
    .faq-item summary{cursor:pointer;font-weight:800}
    .faq-item p{color:#d6d6d6;margin:8px 0 0}

    /* Footer & chat */
    footer{background:#0a0a0a;border-top:1px solid #1c1c1c;margin-top:60px;position:relative}
    footer::before{content:"";position:absolute;top:0;left:50%;transform:translateX(-50%);width:120px;height:3px;background:linear-gradient(90deg,var(--brand),#fff);border-radius:10px;box-shadow:0 0 15px var(--brand)}
    footer .container{padding:26px 0;text-align:center;color:var(--muted)}

    .chat-btn{position:fixed;bottom:20px;right:20px;width:64px;height:64px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 26px var(--brand),0 0 38px rgba(0,255,255,.35);transition:.25s;z-index:120}
    .chat-btn:hover{transform:scale(1.06)}
    .chat-btn svg{stroke:#000}
    .chat-window{position:fixed;bottom:96px;right:20px;width:320px;background:var(--panel);border:1px solid #232323;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.7);display:none;flex-direction:column;overflow:hidden;z-index:115;max-height:60vh}
    .chat-header{background:linear-gradient(90deg,var(--brand),rgba(255,255,255,0.5));color:#000;font-weight:800;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .chat-close{background:none;border:none;font-size:18px;cursor:pointer}
    .chat-messages{flex:1;padding:10px;max-height:260px;overflow-y:auto;color:var(--text);display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .msg{margin:6px 0;padding:8px 12px;border-radius:10px;max-width:80%;word-break:break-word}
    .msg.bot{background:#222;align-self:flex-start;color:var(--text)}
    .msg.user{background:var(--brand);color:#000;align-self:flex-end;font-weight:700}
    .chat-input{display:flex;border-top:1px solid #232323;padding:10px;gap:8px;background:linear-gradient(180deg, transparent, rgba(255,255,255,0.01))}
    .chat-input input{flex:1;padding:10px;border:none;background:#111;color:var(--text);outline:none;border-radius:8px}
    .chat-input button{background:var(--brand);border:none;padding:8px 12px;cursor:pointer;border-radius:8px}

    @media (max-width:520px){
      .chat-window{right:12px;left:12px;width:auto;bottom:88px;max-height:50vh}
      .chat-btn{right:12px;bottom:12px}
    }

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:200}
    .modal.is-open{display:flex}
    .modal-card{width:420px;max-width:94%;background:var(--panel);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 24px 60px rgba(0,0,0,.7)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab-btn{flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .tab-btn.active{background:rgba(255,255,255,0.03);border-color:var(--brand)}
    .form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
    .form-row input{padding:10px;border-radius:8px;border:1px solid #222;background:#0d0d0d;color:var(--text)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn-primary{padding:10px 14px;border-radius:10px;border:none;background:var(--brand);color:#000;font-weight:800;cursor:pointer}
    .btn-ghost{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:92px;background:#111;padding:12px 18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,.6);color:var(--text);z-index:130;display:none}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav" role="banner">
      <a class="brand" href="#" aria-label="PADOBI PC home">
        <span class="brand__logo"><img src="photo_2025-09-02_11-12-54.jpg" alt="Padobi Logo"></span>
        <span class="brand__text" data-i18n="site.brand">PADOBI PC</span>
      </a>

      <div class="actions" role="navigation" aria-label="Header actions">
        <div class="lang" aria-label="Language">
          <button type="button" data-lang="ru" class="neon-hover" aria-pressed="true">RU</button>
          <button type="button" data-lang="ua" class="neon-hover" aria-pressed="false">UA</button>
          <button type="button" data-lang="en" class="neon-hover" aria-pressed="false">EN</button>
        </div>

        <!-- profile button with small avatar -->
        <button id="headerProfileBtn" class="profile-btn" title="Профиль" aria-label="Профиль">
          <img id="smallAvatar" src="" alt="avatar" style="display:none" />
          <svg id="profileIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="7" r="4"/><path d="M6 21a6 6 0 0 1 12 0"/></svg>
        </button>

        <button class="icon-btn neon-hover" title="Корзина" onclick="window.location.href='cart.html'" aria-label="Корзина">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6h15l-1.5 9h-12z"/><path d="M6 6l-2-3"/><circle cx="9" cy="21" r="1.5"/><circle cx="18" cy="21" r="1.5"/></svg>
          <span class="badge" id="cartCount">0</span>
        </button>

        <div class="dropdown" id="menuDropdown">
          <button class="icon-btn neon-hover" id="menuBtn" aria-expanded="false" aria-controls="menu" title="Меню">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          </button>
          <div class="dropdown-menu" id="menu" role="menu" aria-hidden="true">
            <a href="profile.html" data-i18n="menu.profile">Профиль</a>
            <a href="cart.html" data-i18n="menu.cart">Корзина</a>
            <a href="#" data-i18n="menu.settings">Настройки</a>
            <a href="status.html" data-i18n="menu.status">Статус заказа</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero -->
    <section class="section container hero" aria-labelledby="heroTitle">
      <div class="inner">
        <h1 id="heroTitle" data-i18n="hero.title">Сервис будущего в Киеве</h1>
        <p class="sub lead" data-i18n="hero.tag">Твой ПК в надёжных руках — курьер, мастер на дом, гейм-зона и фирменный стиль.</p>
      </div>
    </section>

    <!-- Cards -->
    <section class="section container">
      <div class="grid">
        <div class="card neon-hover" style="background-image:url('pc1.png')">
          <h3 data-i18n="cards.configurator">Конфигуратор</h3>
          <button class="btn" data-i18n="cta.build">Собрать</button>
        </div>
        <div class="card neon-hover" style="background-image:url('pc2.png')">
          <h3 data-i18n="cards.ready">Готовые сборки</h3>
          <button class="btn" data-i18n="cta.view">Смотреть</button>
        </div>
        <div class="card neon-hover" style="background-image:url('pc3.png')">
          <h3 data-i18n="cards.upgrade">Апгрейд</h3>
          <button class="btn" data-i18n="cta.start">Начать</button>
        </div>
      </div>
    </section>

    <!-- Why us -->
    <section class="section container features" aria-labelledby="whyTitle">
      <div class="inner">
        <h2 id="whyTitle" data-i18n="why.title">Почему выбирают нас</h2>
        <p class="lead" data-i18n="why.lead">Бесплатный курьер по Киеву, мастер на дом и гейм‑зона для клиентов. Минимализм, честность и киберпанк‑атмосфера.</p>
        <div class="features-grid" style="margin-top:24px">
          <div class="feature neon-hover">
            <h3 data-i18n="why.courier.title">Бесплатный курьер</h3>
            <p data-i18n="why.courier.text">Заберём ваш ПК, привезём обратно. Удобно и безопасно.</p>
          </div>
          <div class="feature neon-hover">
            <h3 data-i18n="why.game.title">Гейм‑зона</h3>
            <p data-i18n="why.game.text">Пока идёт ремонт — сыграйте на консолях и топовых ПК.</p>
          </div>
          <div class="feature neon-hover">
            <h3 data-i18n="why.honest.title">Честный сервис</h3>
            <p data-i18n="why.honest.text">Прозрачные цены, диагностика и гарантия на все работы 6 месяцев.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Services -->
    <section class="section container services" aria-labelledby="servicesTitle">
      <h2 id="servicesTitle" data-i18n="services.title">Наши услуги</h2>
      <div class="services-grid">
        <!-- services list omitted for brevity; same as before -->
        <div class="service">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18"/><path d="M6 7v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7"/><path d="M10 11h4"/></svg>
          <div>
            <div data-i18n="srv.clean">Чистка</div>
            <small class="muted" data-i18n="srv.clean.desc">Пыль, профилактика, акустика</small>
          </div>
          <div class="price">500 ₴</div>
        </div>
        <!-- ...other services... -->
      </div>

      <div class="services-note" data-i18n="services.note"> 
        Цены указаны за работу. Запчасти по согласованию.
      </div>
    </section>

    <!-- About / Reviews / FAQ -->
    <section class="section container about" aria-labelledby="aboutTitle">
      <div class="inner">
        <h2 id="aboutTitle" data-i18n="about.title">О нас</h2>
        <p class="lead" data-i18n="about.text">PADOBI PC — сервисный центр с характером: уважение к времени клиента. Мы собираем ПК под задачи, апгрейдим по Trade‑In, настраиваем софт и берём ответственность за результат.</p>
      </div>
    </section>

    <section class="section container" aria-labelledby="reviewsTitle">
      <div class="inner">
        <h2 id="reviewsTitle" data-i18n="reviews.title">Отзывы клиентов</h2>
        <div class="reviews-grid" style="margin-top:18px">
          <div class="review"><div class="stars">★★★★★</div><p data-i18n="reviews.r1">«Забрали ПК курьером, через день вернули тихим и быстрым. В гейм‑зоне время пролетело незаметно.»</p></div>
          <div class="review"><div class="stars">★★★★★</div><p data-i18n="reviews.r2">«Прозрачные цены и нормальный диалог. Апгрейд и винда — без воды и лишних наворотов.»</p></div>
          <div class="review"><div class="stars">★★★★★</div><p data-i18n="reviews.r3">«Сервис как в будущем: стиль, порядок и уважение к клиенту. Рекомендую.»</p></div>
        </div>
      </div>
    </section>

    <section class="section container" aria-labelledby="faqTitle">
      <div class="inner">
        <h2 id="faqTitle" data-i18n="faq.title">FAQ</h2>
        <div class="faq-grid" style="margin-top:18px">
          <details class="faq-item"><summary data-i18n="faq.q1">Сколько занимает ремонт?</summary><p data-i18n="faq.a1">В среднем 1–2 дня. Точные сроки зависят от задачи и наличия деталей.</p></details>
          <details class="faq-item"><summary data-i18n="faq.q2">Есть ли гарантия?</summary><p data-i18n="faq.a2">Да. На все работы — 6 месяцев. Условия фиксируем в заказ‑наряде.</p></details>
          <details class="faq-item"><summary data-i18n="faq.q3">Можно ли вызвать мастера домой?</summary><p data-i18n="faq.a3">Да. Приедет мастер или курьер — как удобнее. По Киеву — бесплатно.</p></details>
        </div>
      </div>
    </section>
  </main>

  <footer><div class="container">© <span id="year"></span> <span data-i18n="site.brand">PADOBI PC</span> — <span data-i18n="site.tag">сервис будущего</span></div></footer>

  <!-- Chat (same widget as profile) -->
  <button class="chat-btn" id="chatToggle" aria-label="Открыть чат поддержки"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button>

  <div class="chat-window" id="chatWindow" role="dialog" aria-label="Чат поддержки" aria-hidden="true">
    <div class="chat-header"><span data-i18n="chat.support">Поддержка</span><button class="chat-close" id="chatClose" aria-label="Закрыть">×</button></div>
    <div class="chat-messages" id="chatMessages"><div class="msg bot" data-i18n="chat.greet">Здравствуйте! Чем можем помочь?</div></div>
    <div class="chat-input">
      <input type="text" id="chatInput" data-i18n-placeholder="chat.input" placeholder="Введите сообщение..." aria-label="Сообщение" />
      <button id="chatSend" aria-label="Отправить">➤</button>
    </div>
  </div>

  <!-- Unified Auth Modal (login + register + quick profile) -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="authTitle">Вход / Регистрация</h3>
        <button class="btn-ghost" id="authClose">✕</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Auth tabs">
        <button class="tab-btn active" id="tabLogin" role="tab" aria-selected="true">Войти</button>
        <button class="tab-btn" id="tabRegister" role="tab" aria-selected="false">Зарегистрироваться</button>
      </div>

      <!-- Login form -->
      <div id="loginPane">
        <div class="form-row">
          <input id="loginEmailModal" type="email" placeholder="Email" />
        </div>
        <div class="form-row">
          <input id="loginPasswordModal" type="password" placeholder="Пароль" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="display:flex;gap:8px">
            <button class="btn-primary" id="modalLoginBtn">Войти</button>
            <button class="btn-ghost" id="modalGoogleBtn">Google</button>
          </div>
          <div>
            <button class="btn-ghost" id="toRegisterFromLogin">Нет аккаунта?</button>
          </div>
        </div>
        <div style="margin-top:12px;text-align:center">
          <button class="btn-ghost" id="quickProfileBtn">Перейти в профиль</button>
        </div>
      </div>

      <!-- Register form -->
      <div id="registerPane" style="display:none">
        <div class="form-row"><input id="modalName" type="text" placeholder="Имя" /></div>
        <div class="form-row"><input id="modalPhone" type="tel" placeholder="Телефон (+380...)" /></div>
        <div class="form-row"><input id="modalEmail" type="email" placeholder="Email" /></div>
        <div class="form-row"><input id="modalPassword" type="password" placeholder="Пароль (мин. 6)" /></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn-primary" id="modalRegisterBtn">Зарегистрироваться</button>
          <button class="btn-ghost" id="toLoginFromRegister">Уже есть?</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Сохранено</div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // --- Translations (minimal keys used here) ---
    const translations = {
      ru: { 'site.title':'PADOBI PC — сервис будущего','chat.greet':'Здравствуйте! Чем можем помочь?','chat.thanks':'Спасибо за сообщение! Мы скоро ответим.','auth.fill_all':'Заполните все поля','auth.email_invalid':'Введите корректный email','auth.phone_invalid':'Некорректный телефон','auth.pass_short':'Минимум 6 символов','auth.reg_ok':'Регистрация успешна! Подтвердите email.','auth.reg_error':'Ошибка регистрации','auth.login_error':'Ошибка входа' },
      ua: { 'site.title':'PADOBI PC — сервіс майбутнього','chat.greet':'Вітаємо! Як можемо допомогти?','chat.thanks':'Дякуємо за повідомлення! Ми скоро відповімо.' },
      en: { 'site.title':'PADOBI PC — Future Service','chat.greet':'Hello! How can we help?','chat.thanks':'Thank you! We will reply soon.' }
    };
    const available = Object.keys(translations);
    let currentLang = localStorage.getItem('padobi_lang') || (available.includes((navigator.language||'').slice(0,2)) ? (navigator.language||'').slice(0,2) : 'ru');
    if(!available.includes(currentLang)) currentLang = 'ru';

    function i18n(key){ return translations[currentLang] && translations[currentLang][key] ? translations[currentLang][key] : key; }

    // setLang function (keeps earlier behavior)
    function setText(el, txt){ if(!el) return; el.textContent = txt; }
    function setLang(code){
      if(!translations[code]) return;
      currentLang = code;
      localStorage.setItem('padobi_lang', code);
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(key && translations[code][key] !== undefined) setText(el, translations[code][key]);
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if(key && translations[code][key] !== undefined) el.setAttribute('placeholder', translations[code][key]);
      });
      if(translations[code]['site.title']) document.title = translations[code]['site.title'];
      document.documentElement.setAttribute('lang', code);
      document.querySelectorAll('.lang button').forEach(btn=>{
        const b = btn.getAttribute('data-lang');
        const active = b === code;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
      const firstBot = document.querySelector('.chat-messages .msg.bot');
      if(firstBot) firstBot.textContent = translations[code]['chat.greet'] || firstBot.textContent;
    }

    // Supabase client
    const supabaseUrl = "https://rjqeqffegmejiyakhxza.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqcWVxZmZlZ21laml5YWtoeHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTA2MzcsImV4cCI6MjA3MjM4NjYzN30.KuXUp9tCXmnlCMv3go89E8O_oHOvurErUkcst8UUEGc";
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;

    // utilities
    function showToast(text, ms = 1800){
      const t = document.getElementById('toast');
      t.textContent = text;
      t.style.display = 'block';
      clearTimeout(t._hide);
      t._hide = setTimeout(()=> t.style.display = 'none', ms);
    }

    // init on DOMContentLoaded
    window.addEventListener('DOMContentLoaded', ()=> {
      // language buttons
      document.querySelectorAll('.lang button').forEach(btn=>{
        if(!btn.hasAttribute('data-lang')) btn.setAttribute('data-lang', btn.textContent.toLowerCase());
        btn.style.pointerEvents = 'auto';
        btn.addEventListener('click', ()=> setLang(btn.getAttribute('data-lang')));
      });
      setLang(currentLang);

      // menu toggle (same as before)
      (function(){
        const menuBtn = document.getElementById('menuBtn');
        const menuDropdown = document.getElementById('menuDropdown');
        const menu = document.getElementById('menu');
        if(menuBtn){
          menuBtn.addEventListener('click', ()=>{
            const open = menuDropdown.classList.toggle('open');
            menuBtn.setAttribute('aria-expanded', String(open));
            if(menu) menu.setAttribute('aria-hidden', String(!open));
          });
        }
        document.addEventListener('click', (e)=>{
          if(menuDropdown && !menuDropdown.contains(e.target) && menuDropdown.classList.contains('open')){
            menuDropdown.classList.remove('open');
            menuBtn.setAttribute('aria-expanded','false');
            if(menu) menu.setAttribute('aria-hidden','true');
          }
        });
      })();

      // header profile button behavior -> open auth modal or profile
      document.getElementById('headerProfileBtn').addEventListener('click', async ()=>{
        if(!supabase){ openAuthModal('login'); return; }
        try{
          const { data: { session } } = await supabase.auth.getSession();
          if(session && session.user) {
            window.location.href = 'profile.html';
          } else {
            openAuthModal('login');
          }
        }catch(e){
          console.warn(e);
          openAuthModal('login');
        }
      });

      // init header avatar from current user
      initHeaderAvatar();

      // wire chat (same)
      const chatToggle = document.getElementById('chatToggle');
      const chatWindow = document.getElementById('chatWindow');
      const chatClose = document.getElementById('chatClose');
      const chatSend = document.getElementById('chatSend');
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      function appendUserMessage(text){
        const userMsg = document.createElement('div'); userMsg.className='msg user'; userMsg.textContent=text; chatMessages.appendChild(userMsg); chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function appendBotMessage(text){
        const botMsg = document.createElement('div'); botMsg.className='msg bot'; botMsg.textContent=text; chatMessages.appendChild(botMsg); chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      chatToggle.addEventListener('click', ()=>{
        const isOpen = chatWindow.style.display === 'flex';
        if(isOpen){ chatWindow.style.display='none'; chatWindow.setAttribute('aria-hidden','true'); }
        else{ chatWindow.style.display='flex'; chatWindow.setAttribute('aria-hidden','false'); chatInput && chatInput.focus(); }
      });
      chatClose.addEventListener('click', ()=>{ chatWindow.style.display='none'; chatWindow.setAttribute('aria-hidden','true'); });
      chatSend.addEventListener('click', ()=>{
        const text = (chatInput.value||'').trim(); if(!text) return; appendUserMessage(text); chatInput.value=''; setTimeout(()=> appendBotMessage(i18n('chat.thanks')),600);
      });
      chatInput && chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click(); } });

      // Auth modal wiring
      document.getElementById('authClose').addEventListener('click', closeAuthModal);
      document.getElementById('tabLogin').addEventListener('click', ()=> switchAuthTab('login'));
      document.getElementById('tabRegister').addEventListener('click', ()=> switchAuthTab('register'));
      document.getElementById('toRegisterFromLogin').addEventListener('click', ()=> switchAuthTab('register'));
      document.getElementById('toLoginFromRegister').addEventListener('click', ()=> switchAuthTab('login'));
      document.getElementById('quickProfileBtn').addEventListener('click', async ()=>{
        // If logged in -> go profile, else open login
        if(!supabase){ openAuthModal('login'); return; }
        const { data: { session } } = await supabase.auth.getSession();
        if(session && session.user) window.location.href = 'profile.html';
        else openAuthModal('login');
      });

      document.getElementById('modalLoginBtn').addEventListener('click', modalLogin);
      document.getElementById('modalGoogleBtn').addEventListener('click', ()=> loginWithOAuth('google'));
      document.getElementById('modalRegisterBtn').addEventListener('click', modalRegister);

      // modal overlay close
      const authModal = document.getElementById('authModal');
      authModal.addEventListener('click', (e)=>{ if(e.target === authModal) closeAuthModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAuthModal(); });

    }); // end DOMContentLoaded

    // ---- Auth modal helpers ----
    function openAuthModal(tab = 'login'){
      const modal = document.getElementById('authModal');
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden','false');
      switchAuthTab(tab);
    }
    function closeAuthModal(){
      const modal = document.getElementById('authModal');
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden','true');
    }
    function switchAuthTab(tab){
      const loginPane = document.getElementById('loginPane');
      const registerPane = document.getElementById('registerPane');
      const tabLogin = document.getElementById('tabLogin');
      const tabRegister = document.getElementById('tabRegister');
      if(tab === 'register'){
        loginPane.style.display = 'none';
        registerPane.style.display = 'block';
        tabLogin.classList.remove('active'); tabRegister.classList.add('active');
      } else {
        loginPane.style.display = 'block';
        registerPane.style.display = 'none';
        tabLogin.classList.add('active'); tabRegister.classList.remove('active');
      }
    }

    // --- modal register/login implementations (use same validations as before) ---
    async function modalRegister(){
      const name = (document.getElementById('modalName').value || '').trim();
      const phone = (document.getElementById('modalPhone').value || '').trim();
      const email = (document.getElementById('modalEmail').value || '').trim();
      const password = (document.getElementById('modalPassword').value || '').trim();
      if(!name || !phone || !email || !password){ showToast(i18n('auth.fill_all')); return; }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showToast(i18n('auth.email_invalid')); return; }
      if(!/^\+?\d{10,15}$/.test(phone)){ showToast(i18n('auth.phone_invalid')); return; }
      if(password.length < 6){ showToast(i18n('auth.pass_short')); return; }
      if(!supabase){ showToast('Сервис недоступен'); return; }
      try{
        const { data, error } = await supabase.auth.signUp({
          email, password,
          options: { data: { full_name: name, phone_number: phone } }
        });
        if(error) throw error;
        // If signUp succeeded, attempt signIn (best-effort) so user can continue to profile UX
        try {
          const { error: signinErr } = await supabase.auth.signInWithPassword({ email, password });
          if(!signinErr){
            closeAuthModal();
            showToast(i18n('auth.reg_ok'));
            // update header avatar from newly signed in user (metadata likely empty)
            const { data: { user } } = await supabase.auth.getUser();
            if(user) updateHeaderAvatar(user);
            // redirect to profile
            setTimeout(()=> window.location.href = 'profile.html', 600);
            return;
          }
        } catch(e){}
        closeAuthModal();
        showToast(i18n('auth.reg_ok'));
      }catch(err){
        console.error('modalRegister', err);
        showToast((i18n('auth.reg_error') || 'Ошибка регистрации') + (err?.message ? ': '+err.message : ''));
      }
    }

    async function modalLogin(){
      const email = (document.getElementById('loginEmailModal').value || '').trim();
      const password = (document.getElementById('loginPasswordModal').value || '').trim();
      if(!email || !password){ showToast(i18n('auth.fill_all')); return; }
      if(!supabase){ showToast('Сервис недоступен'); return; }
      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error;
        closeAuthModal();
        // update header avatar
        const { data: { user } } = await supabase.auth.getUser();
        if(user) updateHeaderAvatar(user);
        // redirect to profile
        window.location.href = 'profile.html';
      }catch(err){
        console.error('modalLogin', err);
        showToast((i18n('auth.login_error') || 'Ошибка входа') + (err?.message ? ': '+err.message : ''));
      }
    }

    async function loginWithOAuth(provider){
      if(!supabase){ showToast('Сервис недоступен'); return; }
      try{
        await supabase.auth.signInWithOAuth({ provider });
        // redirect will happen through Supabase
      }catch(err){
        console.error('loginWithOAuth', err);
        showToast((i18n('auth.login_error') || 'Ошибка входа') + (err?.message ? ': '+err.message : ''));
      }
    }

    // update header avatar from user object
    async function updateHeaderAvatarFromUser(user){
      if(!user) {
        document.getElementById('smallAvatar').style.display = 'none';
        document.getElementById('profileIcon').style.display = 'block';
        return;
      }
      const avatarUrl = user.user_metadata?.avatar_url;
      if(avatarUrl){
        document.getElementById('smallAvatar').src = avatarUrl;
        document.getElementById('smallAvatar').style.display = 'block';
        document.getElementById('profileIcon').style.display = 'none';
      } else {
        document.getElementById('smallAvatar').style.display = 'none';
        document.getElementById('profileIcon').style.display = 'block';
      }
    }

    async function initHeaderAvatar(){
      if(!supabase) return;
      try{
        const { data: { user } } = await supabase.auth.getUser();
        await updateHeaderAvatarFromUser(user);
        // react to auth changes
        if(supabase.auth.onAuthStateChange){
          supabase.auth.onAuthStateChange(async (event, session) => {
            const u = session?.user || null;
            await updateHeaderAvatarFromUser(u);
          });
        }
      }catch(e){ console.warn('initHeaderAvatar', e); }
    }

    // helper: signInWithGoogle for modal button
    async function loginWithGoogle(){ return loginWithOAuth('google'); }

    // Accessibility: global Esc closes cart/menu/modal/chat
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        const authModal = document.getElementById('authModal');
        if(authModal && authModal.classList.contains('is-open')) closeAuthModal();
        const chatWindow = document.getElementById('chatWindow');
        if(chatWindow && chatWindow.style.display === 'flex'){ chatWindow.style.display = 'none'; chatWindow.setAttribute('aria-hidden','true'); }
        const menuDropdown = document.getElementById('menuDropdown');
        if(menuDropdown && menuDropdown.classList.contains('open')){ menuDropdown.classList.remove('open'); document.getElementById('menuBtn').setAttribute('aria-expanded','false'); document.getElementById('menu').setAttribute('aria-hidden','true'); }
      }
    });
  </script>
</body>
</html>
